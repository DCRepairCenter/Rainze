<a id="readme-top"></a>

<!-- æ¨¡å—å¾½ç«  -->
[![Status][status-shield]][status-url]

# Animation åŠ¨ç”»ç³»ç»Ÿæ¨¡å—

> ç®¡ç†æ¡Œå® çš„6å±‚åŠ¨ç”»ç³»ç»Ÿï¼ŒåŒ…æ‹¬å¸§æ¸²æŸ“ã€è¡¨æƒ…æ§åˆ¶ã€åŠ¨ä½œæ’­æ”¾ã€å£å‹åŒæ­¥

## ğŸ“– ç›®å½•

- [å…³äºæ¨¡å—](#å…³äºæ¨¡å—)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [API å‚è€ƒ](#api-å‚è€ƒ)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [ä¾èµ–å…³ç³»](#ä¾èµ–å…³ç³»)

## å…³äºæ¨¡å—

Animation æ¨¡å—è´Ÿè´£ Rainze æ¡Œå® çš„æ‰€æœ‰è§†è§‰åŠ¨ç”»ï¼Œé‡‡ç”¨6å±‚åŠ¨ç”»æ¶æ„å®ç°ä¸°å¯Œçš„è¡¨ç°åŠ›ã€‚

### æ ¸å¿ƒèŒè´£

| èŒè´£ | è¯´æ˜ |
|------|------|
| å¸§æ¸²æŸ“ | ç®¡ç†å¸§åºåˆ—ã€æ’­æ”¾æ—¶åº |
| è¡¨æƒ…æ§åˆ¶ | å“åº”æƒ…æ„Ÿæ ‡ç­¾ï¼Œæ§åˆ¶è¡¨æƒ…å˜åŒ– |
| åŠ¨ä½œæ’­æ”¾ | æ‰§è¡Œè‚¢ä½“åŠ¨ä½œåŠ¨ç”» |
| ç‰¹æ•ˆç³»ç»Ÿ | æ’­æ”¾ç²’å­ç‰¹æ•ˆ |
| å£å‹åŒæ­¥ | æ”¯æŒéŸ³é¢‘/æ–‡æœ¬é©±åŠ¨çš„å˜´å‹åŠ¨ç”» |

### æŠ€æœ¯æ ˆ

* ![Python](https://img.shields.io/badge/Python-3.12+-blue)
* ![PySide6](https://img.shields.io/badge/PySide6-6.6+-green)

<p align="right">(<a href="#readme-top">è¿”å›é¡¶éƒ¨</a>)</p>

## æ¶æ„è®¾è®¡

### 6å±‚åŠ¨ç”»æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 5: LipSync (å£å‹å±‚)                               â”‚
â”‚   - å˜´å‹åŠ¨ç”» (A, I, U, E, O, é—­å˜´)                      â”‚
â”‚   - ä¼˜å…ˆçº§: æœ€é«˜ï¼Œè¦†ç›–Layer 2å˜´éƒ¨                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: Effect (ç‰¹æ•ˆå±‚)                                â”‚
â”‚   - ç²’å­æ•ˆæœ (æ˜Ÿæ˜Ÿã€çˆ±å¿ƒã€æ±—æ»´)                         â”‚
â”‚   - ä¼˜å…ˆçº§: é«˜ï¼Œå¯ä¸ä»»ä½•çŠ¶æ€å åŠ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: Action (åŠ¨ä½œå±‚)                                â”‚
â”‚   - è‚¢ä½“åŠ¨ä½œ (æŒ¥æ‰‹ã€è·³è·ƒã€æ‹¥æŠ±)                         â”‚
â”‚   - äº‹ä»¶è§¦å‘ï¼Œç»“æŸåè¿”å›Idle                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: Expression (è¡¨æƒ…å±‚)                            â”‚
â”‚   - çœ¼ç›ã€çœ‰æ¯›ã€å˜´å·´è¡¨æƒ…                                â”‚
â”‚   - æ ¹æ®emotion_tagåˆ‡æ¢                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: Idle (å¾…æœºå±‚)                                  â”‚
â”‚   - å¾…æœºåŠ¨ç”»å¾ªç¯ (å‘¼å¸ã€å¾®åŠ¨)                           â”‚
â”‚   - æŒç»­æ’­æ”¾                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 0: Base (åŸºç¡€å±‚)                                  â”‚
â”‚   - è§’è‰²ä¸»ä½“ã€æœè£…                                      â”‚
â”‚   - æ¢è£…æ—¶å˜åŒ–                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
animation/
â”œâ”€â”€ __init__.py           # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ controller.py         # AnimationController ä¸»æ§åˆ¶å™¨
â”œâ”€â”€ models/               # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ animation.py      # AnimationState, AnimationFrame
â”œâ”€â”€ frames/               # å¸§åŠ¨ç”»å¤„ç†
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ sequence.py       # FrameSequence å¸§åºåˆ—
â”‚   â””â”€â”€ player.py         # FramePlayer æ’­æ”¾å™¨
â””â”€â”€ layers/               # åŠ¨ç”»å±‚
    â”œâ”€â”€ __init__.py
    â””â”€â”€ base_layer.py     # AnimationLayer åŸºç±»
```

<p align="right">(<a href="#readme-top">è¿”å›é¡¶éƒ¨</a>)</p>

## å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

* Python 3.12+
* PySide6 6.6+
* rainze.core.contracts (EmotionTag)
* rainze.core.event_bus (EventBus)

### åŸºæœ¬ä½¿ç”¨

```python
from rainze.animation import AnimationController, AnimationState

# åˆ›å»ºæ§åˆ¶å™¨
controller = AnimationController(
    event_bus=app.event_bus,
    resource_path="./assets/animations",
    fps=30,
)

# åˆå§‹åŒ–
await controller.initialize()

# è¿æ¥ä¿¡å·åˆ° GUI
controller.frame_ready.connect(window.update_pet_image)

# å¯åŠ¨æ¸²æŸ“å¾ªç¯
controller.start_render_loop()

# è®¾ç½®è¡¨æƒ…
controller.set_expression("happy", intensity=0.8)

# æ’­æ”¾åŠ¨ä½œ
controller.play_action("wave", on_complete=lambda: print("å®Œæˆ"))

# å¤„ç† AI å“åº”ä¸­çš„æƒ…æ„Ÿæ ‡ç­¾
response = "ä½ å¥½~ [EMOTION:happy:0.8]"
tag = controller.parse_emotion_tag(response)
if tag:
    controller.apply_emotion_tag(tag)
```

<p align="right">(<a href="#readme-top">è¿”å›é¡¶éƒ¨</a>)</p>

## API å‚è€ƒ

### `AnimationController`

ä¸»åŠ¨ç”»æ§åˆ¶å™¨ï¼Œç®¡ç†æ‰€æœ‰åŠ¨ç”»å±‚å’Œæ¸²æŸ“ã€‚

| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `initialize()` | - | `None` | å¼‚æ­¥åˆå§‹åŒ–æ§åˆ¶å™¨ |
| `set_expression()` | `emotion_tag, intensity, duration_ms` | `None` | è®¾ç½®è¡¨æƒ… |
| `play_action()` | `action_name, on_complete` | `bool` | æ’­æ”¾åŠ¨ä½œ |
| `play_effect()` | `effect_name, duration_ms` | `None` | æ’­æ”¾ç‰¹æ•ˆ |
| `start_lipsync()` | `audio_data` | `None` | å¼€å§‹éŸ³é¢‘å£å‹åŒæ­¥ |
| `start_text_lipsync()` | `text, duration_ms` | `None` | å¼€å§‹æ–‡æœ¬å£å‹åŒæ­¥ |
| `parse_emotion_tag()` | `response_text` | `EmotionTag?` | è§£ææƒ…æ„Ÿæ ‡ç­¾ |
| `apply_emotion_tag()` | `tag` | `None` | åº”ç”¨æƒ…æ„Ÿæ ‡ç­¾ |
| `render_frame()` | - | `QPixmap` | æ¸²æŸ“å½“å‰å¸§ |
| `start_render_loop()` | - | `None` | å¯åŠ¨æ¸²æŸ“å¾ªç¯ |
| `stop_render_loop()` | - | `None` | åœæ­¢æ¸²æŸ“å¾ªç¯ |

**ä¿¡å· (Signals):**

| ä¿¡å· | å‚æ•° | è¯´æ˜ |
|------|------|------|
| `frame_ready` | `QPixmap` | æ–°å¸§å‡†å¤‡å®Œæˆ |
| `state_changed` | `AnimationState` | åŠ¨ç”»çŠ¶æ€å˜åŒ– |
| `action_completed` | `str` | åŠ¨ä½œæ’­æ”¾å®Œæˆ |
| `expression_changed` | `str, float` | è¡¨æƒ…å˜åŒ– |

### `AnimationState`

åŠ¨ç”»çŠ¶æ€æšä¸¾ã€‚

| å€¼ | è¯´æ˜ |
|------|------|
| `IDLE` | å¾…æœºçŠ¶æ€ |
| `TALKING` | è¯´è¯ä¸­ |
| `REACTING` | è¡¨æƒ…ååº” |
| `ACTING` | æ‰§è¡ŒåŠ¨ä½œ |
| `TRANSITIONING` | çŠ¶æ€è¿‡æ¸¡ |
| `SLEEPING` | ç¡çœ çŠ¶æ€ |

### `FrameSequence`

å¸§åºåˆ—ç®¡ç†ç±»ã€‚

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `add_frame(frame)` | æ·»åŠ å¸§ |
| `get_frame_at_time(elapsed_ms)` | æ ¹æ®æ—¶é—´è·å–å¸§ |
| `from_pixmaps(pixmaps, duration_ms)` | ä» QPixmap åˆ—è¡¨åˆ›å»º |

### `FramePlayer`

å¸§æ’­æ”¾å™¨ã€‚

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `set_sequence(seq, auto_play)` | è®¾ç½®å¸§åºåˆ— |
| `play(on_complete)` | å¼€å§‹æ’­æ”¾ |
| `pause()` | æš‚åœ |
| `resume()` | æ¢å¤ |
| `stop()` | åœæ­¢ |
| `seek(time_ms)` | è·³è½¬åˆ°æŒ‡å®šæ—¶é—´ |
| `update(delta_ms)` | æ›´æ–°æ’­æ”¾çŠ¶æ€ |

<p align="right">(<a href="#readme-top">è¿”å›é¡¶éƒ¨</a>)</p>

## é…ç½®è¯´æ˜

ç›¸å…³é…ç½®æ–‡ä»¶ï¼š`config/animation_settings.json`

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `fps` | `int` | `30` | ç›®æ ‡å¸§ç‡ |
| `canvas_size` | `[int, int]` | `[256, 256]` | ç”»å¸ƒå¤§å° |
| `expression_transition_ms` | `int` | `200` | è¡¨æƒ…è¿‡æ¸¡æ—¶é•¿ |
| `action_duration_ms` | `int` | `1000` | é»˜è®¤åŠ¨ä½œæ—¶é•¿ |
| `effect_duration_ms` | `int` | `2000` | é»˜è®¤ç‰¹æ•ˆæ—¶é•¿ |

<p align="right">(<a href="#readme-top">è¿”å›é¡¶éƒ¨</a>)</p>

## ä¾èµ–å…³ç³»

### ä¾èµ–çš„æ¨¡å—
- `rainze.core.contracts` - EmotionTag å…±äº«ç±»å‹
- `rainze.core.event_bus` - EventBus äº‹ä»¶æ€»çº¿

### è¢«ä¾èµ–äº
- `rainze.gui` - GUI å±‚æ¥æ”¶ frame_ready ä¿¡å·
- `rainze.ai` - AI æ¨¡å—ä¼ é€’æƒ…æ„Ÿæ ‡ç­¾

<p align="right">(<a href="#readme-top">è¿”å›é¡¶éƒ¨</a>)</p>

<!-- MARKDOWN LINKS -->
[status-shield]: https://img.shields.io/badge/Status-å¼€å‘ä¸­-yellow
[status-url]: #
